#!/usr/bin/env python3
import os
import tarfile
import urllib.request

from ghostman import Config


def get_base_directory():
    return os.path.dirname(os.path.dirname(__file__))


def get_application_name():
    return os.path.basename(__file__)


def progress(chunk_number, chunk_max_size, download_size):
    if download_size:
        if chunk_max_size > download_size:
            percentage = chunk_number
        else:
            percentage = chunk_max_size / download_size * chunk_number
        print(f"{percentage:4.0%} done")


def main():
    base_directory = get_base_directory()
    application_name = get_application_name()
    config = Config(base_directory, application_name)
    print(config.options.root_dir)
    for repository in config.repositories:
        print(repository.database_url)
        db_file = f"{repository.name}.db"
        if os.path.isfile(db_file):
            result = urllib.request.urlretrieve(repository.database_url, db_file, reporthook=progress)
        else:
            print(os.path.getmtime(db_file))
        if not tarfile.is_tarfile(db_file):
            print("WTF!")
        with tarfile.open(db_file) as t:
            for member in t.getmembers():
                print(member.name)
                if "desc" in member.name:
                    output = t.extractfile(member)
                    print(output.read().decode('utf-8'))
                    t.close()


if __name__ == "__main__":
    main()
